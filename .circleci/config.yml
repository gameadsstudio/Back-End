version: 2.1

jobs:
  push-to-registry-latest:
    machine: true
    steps:
      - checkout
      # start proprietary DB using private Docker image
      # with credentials stored in the UI
      - run: echo "$DOCKER_PASS" | docker login $REGISTRY_URL --username $DOCKER_USER --password-stdin

      # build the application image
      - run: docker build -t $REGISTRY_URL/gas-api:latest ./api/

      # deploy the image
      - run: docker push $REGISTRY_URL/gas-api:latest
  push-to-registry-production:
    machine: true
    steps:
     - checkout
     # start proprietary DB using private Docker image
     # with credentials stored in the UI
     - run: echo "$DOCKER_PASS" | docker login $REGISTRY_URL --username $DOCKER_USER --password-stdin

     # build the application image
     - run: docker build -t $REGISTRY_URL/gas-api:production ./api/

     # deploy the image
     - run: docker push $REGISTRY_URL/gas-api:production
      
workflows:
  build-and-deploy: 
    jobs:
      - push-to-registry-latest:
          context: registry
          filters:
            branches:
              only:
                - dev
      - push-to-registry-production:
          context: registry
          filters:
            branches:
              only:
                - master
